{% extends "extend/base.html" %}

{% block content %}
	{% if user.is_authenticated %}

	<style>
		body {
			padding: 0;
		}
		#userbar
		{
			background-color: #333;
			color: whitesmoke;
			padding: 3px;
		}
		#userbar a
		{
			color: lightblue;
		}
		#sidebar
		{
			width: 225px;
		}
		#explorer 
		{
			border-left: 2px solid #AAA;
			width: 600px;
		}
		.subscription-node
		{
			background-color: #DDD;
			margin: 3px 0;
			padding: 2px 5px;
		}
		.subscription-node:hover
		{	
			background-color: #CCC;
			cursor: pointer;
		}

		.subscription-node.selected
		{
			background-color: #BBB;
		}

		.subscription-explorer-node
		{
			background-color: #DDD;
			margin: 3px 0;
			padding: 2px 5px;
		}
		.subscription-explorer-node:hover
		{	
			background-color: #CCC;
			cursor: pointer;
		}
		.subscription-explorer-node-title
		{
			font-weight:bold;
		}

	</style>
	{% csrf_token %}
	<script>
		

		function getCSRF()
		{
			return document.getElementsByName('csrfmiddlewaretoken')[0].value;
		}
		$(function () {
			Handlebars.registerHelper('link', function(text, url) {
		  		text = Handlebars.Utils.escapeExpression(text);
		  		url  = Handlebars.Utils.escapeExpression(url);

		  		var result = '<a href="' + url + '">' + text + '</a>';

		  		return new Handlebars.SafeString(result);
			});

			$(".subscription-node").click(function () {
				var subscriptionid = $(this).attr("js-subscription-id");
				SelectSubscription($(this));

				LoadSubscription(subscriptionid);
			});

			var firstElement = $(".subscription-node").first();

			if(firstElement !== undefined)
			{
				SelectSubscription(firstElement);
				var subscriptionid = firstElement.attr("js-subscription-id");
				LoadSubscription(subscriptionid);
			}
		});

		function SelectSubscription(item)
		{
			$(".subscription-node").removeClass("selected");
			item.addClass("selected");
		}

		function LoadSubscription(subscriptionid)
		{
			$.ajax({
					type: "POST",
					url : "http://localhost:8000/api/get_subscription_items",
					data : {
						csrfmiddlewaretoken: getCSRF(),
						subscription_id: subscriptionid
					},
					beforeSend: function (){
						$("#explorer").html("");
						$("#explorer").html("<img src='/static/images/explorer_loading.gif' />");
					},
					success: function (msg) {
						$("#explorer").html("");

						var source   = $("#item-template").html();
						var template = Handlebars.compile(source);

						for(var i = 0; i < msg.length; i ++)
						{		
							var html = template(msg[i]);

							$("#explorer").append(html);
						}

						BindLinks();
					}
				});
		}

		function BindLinks()
		{
			$(".subscription-explorer-node").click(function () {
				window.location = $(this).attr("js-item-link");
			});
		}
	</script>

		<div id="userbar">
			Hello {{ user.username }}!
			<a href="{% url 'logout-user' %}">Logout</a>
		</div>
		<div class="clearfix">
			<div id="sidebar" class="pull-left">
				{% for subscription in subscriptions %}
					<div class='subscription-node' js-subscription-id="{{ subscription.id }}">
						{{ subscription.title }}
					</div>
				{% endfor %}
			</div>
			<div id="explorer" class="pull-left">
				Select a subscription to the left!
			</div>
		</div>

	{% verbatim %}
		<script id="item-template" type="text/x-handlebars-template">
			<div js-item-link="{{url}}" class="subscription-explorer-node">
				<div class="subscription-explorer-node-title">
					{{title}}
				</div>
				<div class="subscription-explorer-node-content">
					{{{content}}}
				</div>	
			</div>
		</script>
	{% endverbatim %}

	{% else %}
		{% if form.errors %}
		<p>Your username and password didn't match. Please try again.</p>
		{% endif %}

		<form class="form-signin" role="form" method="post" action="{% url 'login-user' %}">
			{% csrf_token %}
			<h4 class="form-signin-heading">Please Login</h4>
			<input id="id_username" class="form-control" maxlength="254" name="username" type="text" clickev="true" placeholder="Username" autofocus>
			<input id="id_password" class="form-control" name="password" type="password" clickev="true" placeholder=Password>
			<button type="submit" class="btn btn-default btn-success">Sign in</button>
		</form>

		<a href="#">Sign up</a>

		<a href="#">Forgot Password</a>
	{% endif %}

{% endblock %}